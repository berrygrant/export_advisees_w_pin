<!DOCTYPE html>
<html>
<head>
  <title>Villanova Advisee Export Tool</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 60px; }
    .button {
      display:inline-block;
      padding:14px 24px;
      background:#003366;
      color:white;
      text-decoration:none;
      border-radius:6px;
      font-weight:bold;
      font-size:18px;
    }
  </style>
</head>
<body>
  <h1>Advisee Export Tool</h1>
  <h2>Author: <a href="https://grantberry.info" target="_blank">Grant Berry</a></h2>
  <i>This tool is designed for Villanova faculty to extract their full list of advisees with their registration pins from the <a href="https://banssb9.villanova.edu/BannerExtensibility/customPage/page/VUAdviseeListWithPins" target="_blank">"Advisee List With Pins"</a> page in Banner.</i><br/>
  <p><strong>Step 1:</strong> Drag the button below to your bookmarks bar.</p>
  <p>
    <a class="button" href="javascript:(function(){
      function stripEmail(s){
        var m=/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i.exec(s||'');
        return m?m[0]:s;
      }
      function cleanRows(rows){
        return rows.map(r=>{
          let primary='';
          if(r.SGRADVR_ADVR_CODE==='ACAD'){ primary='YES'; }
          else if(r.SGRADVR_ADVR_CODE==='ACA2'){ primary='NO'; }
          return {
            LAST_NAME:r.SPRIDEN_LAST_NAME||'',
            FIRST_NAME:r.SPRIDEN_FIRST_NAME||'',
            MIDDLE_NAME:r.SPRIDEN_MI||'',
            PREFERRED_NAME:r.PREF_NAME||'',
            EMAIL:stripEmail(r.EMAIL||''),
            MAJOR:r.MAJR||'',
            PIN:r.SPRAPIN_PIN||'',
            REG_BEGIN_DATE:r.REG_BEGIN_DATE||'',
            REG_BEGIN_TIME:r.REG_BEGIN_TIME||'',
            PRIMARY:primary
          };
        });
      }
      function toTSV(rows){
        if(!rows.length) return '';
        const headers=['LAST_NAME','FIRST_NAME','MIDDLE_NAME','PREFERRED_NAME','EMAIL','MAJOR','PIN','REG_BEGIN_DATE','REG_BEGIN_TIME','PRIMARY'];
        let lines=[headers.join('\t')];
        for(const r of rows){
          lines.push(headers.map(h=>r[h]||'').join('\t'));
        }
        return lines.join('\n');
      }
      const entries=performance.getEntriesByType('resource').map(e=>e.name).filter(u=>u.includes('VUAdviseeListWithPinsSGRADVR'));
      if(!entries.length){
        alert('Could not find the advisee data request. Please select a term and choose Show 100 so the table loads.');
        return;
      }
      const apiUrl=entries[entries.length-1];
      fetch(apiUrl).then(r=>r.json()).then(data=>{
        let rows=Array.isArray(data)?data:(data.items||data.data||data.rows||[]);
        let cleaned=cleanRows(rows);
        if(!cleaned.length){
          alert('No advisees found. Make sure the advisee list is visible.');
          return;
        }
        let tsv=toTSV(cleaned);
        let blob=new Blob([tsv],{type:'text/tab-separated-values'});
        let a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download='my_advisees_w_pin.txt';
        a.click();
      }).catch(err=>alert('Error fetching advisees: '+err));
    })();">ðŸ“Œ Export Advisees w/Registration Pins</a>
  </p>
  <p><strong>Step 2:</strong> Log into MyNova and click "Advisee List with PIN and Class Code" (or go <a href="https://banssb9.villanova.edu/BannerExtensibility/customPage/page/VUAdviseeListWithPins" target="_blank">here</a>)</p>
   <p><strong>Step 3:</strong> Select the correct term and click <em>Show 100</em> from the dropdown menu at the bottom of the table.</p>
  <p><strong>Step 4:</strong> click the new <strong>ðŸ“Œ Export Advisees</strong> bookmark</p>
  <p>You will then be asked where to store the result file. By default, it's stored as tab-delimited text (<code>.txt</code>). This can be read directly into Excel or copied and pasted into Excel.</p>
</body>
</html>